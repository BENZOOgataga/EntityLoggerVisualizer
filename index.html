<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pegasus Entity Log Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #181c20;
      --panel: #23272b;
      --accent: #4fd1c5;
      --text: #e0e0e0;
      --text-muted: #8a8a8a;
      --border: #2c3136;
      --hover: #232b30;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      background: var(--panel);
      border-radius: 12px;
      box-shadow: 0 2px 16px #0004;
    }
    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5em;
      color: var(--accent);
    }
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 40px 0;
      text-align: center;
      color: var(--text-muted);
      background: var(--bg);
      cursor: pointer;
      margin-bottom: 24px;
      transition: border-color 0.2s;
    }
    .upload-area.dragover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .file-input {
      display: none;
    }
    .file-list {
      margin-bottom: 24px;
    }
    .file-section {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 18px;
      overflow: hidden;
    }
    .file-header {
      padding: 14px 18px;
      font-weight: 500;
      background: var(--panel);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .file-header:hover {
      background: var(--hover);
    }
    .file-content {
      padding: 16px 18px;
      display: none;
      animation: fadeIn 0.3s;
    }
    .file-section.open .file-content {
      display: block;
    }
    .entity-group {
      margin-bottom: 10px;
    }
    .entity-summary {
      cursor: pointer;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      color: var(--accent);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: color 0.2s;
    }
    .entity-summary:hover {
      color: #fff;
    }
    .entity-details {
      margin: 6px 0 12px 18px;
      font-size: 0.97em;
      color: var(--text-muted);
      display: none;
    }
    .entity-group.open .entity-details {
      display: block;
    }
    .tps {
      font-size: 1.1em;
      margin: 10px 0 18px 0;
      color: var(--text-muted);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .welcome {
      text-align: center;
      color: var(--text-muted);
      margin: 40px 0;
      font-size: 1.1em;
    }
    @media (max-width: 600px) {
      .container { padding: 10px; }
      .file-header, .file-content { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pegasus Entity Log Visualizer</h1>
    <div class="upload-area" id="upload-area">
      <div>Drag & drop Pegasus <b>.xlsx</b> logs here<br>or <span style="color:var(--accent);text-decoration:underline;cursor:pointer;" id="browse-link">browse</span> to select files</div>
      <input type="file" class="file-input" id="file-input" accept=".xlsx" multiple>
    </div>
    <div id="output"></div>
    <div class="welcome" id="welcome-msg">
      <p>Welcome!<br>Upload one or more Pegasus log files (<code>.xlsx</code>) generated by the mod.<br>
      Use <code>/pegasus forcelogs</code> in-game or wait for automatic logs.<br>
      All processing is done locally in your browser.</p>
    </div>
  </div>
  <script>
    // --- UI Elements ---
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const output = document.getElementById('output');
    const welcomeMsg = document.getElementById('welcome-msg');
    const browseLink = document.getElementById('browse-link');

    // --- Drag & Drop ---
    uploadArea.addEventListener('click', () => fileInput.click());
    browseLink.addEventListener('click', e => {
      e.stopPropagation();
      fileInput.click();
    });
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', e => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', e => {
      handleFiles(e.target.files);
    });

    // --- File Handling ---
    function handleFiles(fileList) {
      if (!fileList.length) return;
      welcomeMsg.style.display = 'none';
      output.innerHTML = '';
      const files = Array.from(fileList).filter(f => f.name.endsWith('.xlsx'));
      if (!files.length) {
        output.innerHTML = '<div class="welcome">No valid .xlsx files selected.</div>';
        return;
      }
      // Sort files by timestamp in filename if present, else by name
      files.sort((a, b) => extractTimestamp(a.name) - extractTimestamp(b.name));
      processFiles(files);
    }

    // --- Timestamp Extraction ---
    function extractTimestamp(filename) {
      // Try to extract yyyymmdd_hhmmss or similar
      const match = filename.match(/(\d{8,})(?:[_-](\d{6,}))?/);
      if (match) {
        const date = match[1];
        const time = match[2] || '000000';
        return Number(date + time);
      }
      return filename;
    }

    // --- Main Processing ---
    async function processFiles(files) {
      for (const file of files) {
        await processFile(file);
      }
    }

    async function processFile(file) {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });
      // Group entities/items
      const groups = {};
      let tps = null;
      for (const row of rows) {
        if (!row.length) continue;
        if (row[0] === 'TPS') {
          tps = row[1];
          continue;
        }
        const [Type, Name, Dimension, X, Y, Z, Quantity] = row;
        const key = `${Type}:${Name}`;
        if (!groups[key]) {
          groups[key] = {
            type: Type,
            name: Name,
            total: 0,
            coords: [],
          };
        }
        groups[key].total += Number(Quantity) || 0;
        groups[key].coords.push({ dim: Dimension, x: X, y: Y, z: Z, qty: Quantity });
      }
      renderFileSection(file.name, tps, groups);
    }

    // --- Rendering ---
    function renderFileSection(filename, tps, groups) {
      const section = document.createElement('div');
      section.className = 'file-section';
      // Header
      const header = document.createElement('div');
      header.className = 'file-header';
      header.innerHTML = `<span>${filename}</span><span style="font-size:0.95em;color:var(--text-muted);">TPS: ${tps ?? 'N/A'}</span>`;
      section.appendChild(header);
      // Content
      const content = document.createElement('div');
      content.className = 'file-content';
      // Entity groups
      Object.values(groups)
        .sort((a, b) => b.total - a.total)
        .forEach(group => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'entity-group';
          // Summary
          const summary = document.createElement('div');
          summary.className = 'entity-summary';
          summary.textContent = `${capitalize(group.name)} (x${group.total})`;
          groupDiv.appendChild(summary);
          // Details
          const details = document.createElement('div');
          details.className = 'entity-details';
          details.innerHTML = group.coords.map(c =>
            `<div>${group.type} in <b>${c.dim}</b> at <code>[${c.x}, ${c.y}, ${c.z}]</code> (x${c.qty})</div>`
          ).join('');
          groupDiv.appendChild(details);
          // Expand/collapse
          summary.addEventListener('click', () => {
            groupDiv.classList.toggle('open');
          });
          content.appendChild(groupDiv);
        });
      section.appendChild(content);
      // Expand/collapse file section
      header.addEventListener('click', () => {
        section.classList.toggle('open');
      });
      output.appendChild(section);
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  </script>
</body>
</html>